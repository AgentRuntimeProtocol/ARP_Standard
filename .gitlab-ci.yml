stages:
  - lint
  - validate
  - codegen
  - release
  - publish

workflow:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH

lint_json:
  stage: lint
  image: python:3.11
  script:
    - python tools/lint/lint_json.py
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success

validate_examples:
  stage: validate
  image: python:3.11
  script:
    - python -m pip install -r tools/validate/requirements.txt
    - python tools/validate/validate_json_vectors.py --version v1 --include-examples
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success

bundle_openapi:
  stage: validate
  image: alpine:3.19
  script:
    - echo "OpenAPI bundling is toolchain-dependent; see tools/bundle/README.md"
  rules:
    - when: manual

codegen_python:
  stage: codegen
  image: python:3.11
  script:
    - python -m venv .venv
    - .venv/bin/python -m pip install --upgrade pip
    - .venv/bin/python -m pip install -r tools/codegen/python/model/requirements.txt
    - .venv/bin/python -m pip install -r tools/codegen/python/client/requirements-dev.txt
    - .venv/bin/python -m pip install -r tools/codegen/python/server/requirements.txt
    - .venv/bin/python -m pip install -r tools/validate/requirements.txt
    - .venv/bin/python tools/validate/validate_openapi.py --version v1
    - .venv/bin/python tools/validate/validate_generated_artifacts.py
    - .venv/bin/python tools/codegen/python/model/generate.py --version v1
    - .venv/bin/python tools/codegen/python/client/generate.py --version v1
    - .venv/bin/python tools/codegen/python/server/generate.py --version v1
    - .venv/bin/python tools/conformance/sync_spec.py --version v1
    - mkdir -p artifacts
    - .venv/bin/python tools/codegen/python/report_codegen.py --version v1 --out artifacts/codegen-report.txt
    - tar -czf artifacts/python-codegen-src.tgz \
        clients/python/src/arp_standard_client \
        models/python/src/arp_standard_model/_generated.py \
        models/python/src/arp_standard_model/_requests.py \
        kits/python/src/arp_standard_server
    - .venv/bin/python -m pip install -e "models/python"
    - .venv/bin/python -m pip install -e "clients/python[dev]"
    - .venv/bin/python -m pip install -e "kits/python"
    - .venv/bin/python -m pip install -e "conformance/python"
    - .venv/bin/pyright -p clients/python/pyrightconfig.json
    - .venv/bin/pyright -p kits/python/pyrightconfig.json
    - .venv/bin/python -m unittest discover -s tests
    - .venv/bin/python -m build models/python --sdist --wheel --outdir models/python/dist
    - .venv/bin/python -m build clients/python --sdist --wheel --outdir clients/python/dist
    - .venv/bin/python -m build kits/python --sdist --wheel --outdir kits/python/dist
    - .venv/bin/python -m build conformance/python --sdist --wheel --outdir conformance/python/dist
    - .venv/bin/python -m twine check models/python/dist/*
    - .venv/bin/python -m twine check clients/python/dist/*
    - .venv/bin/python -m twine check kits/python/dist/*
    - .venv/bin/python -m twine check conformance/python/dist/*
    - .venv/bin/python tools/codegen/python/verify_dist_dependencies.py
  artifacts:
    paths:
      - artifacts/codegen-report.txt
      - artifacts/python-codegen-src.tgz
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success

release_build:
  stage: release
  image: python:3.11
  script:
    - git fetch origin main
    - |
      if ! git merge-base --is-ancestor "$CI_COMMIT_SHA" "origin/main"; then
        echo "Ref ${CI_COMMIT_TAG} (${CI_COMMIT_SHA}) is not contained in origin/main"
        exit 1
      fi
    - python -m venv .venv
    - .venv/bin/python -m pip install --upgrade pip
    - .venv/bin/python -m pip install -r tools/codegen/python/model/requirements.txt
    - .venv/bin/python -m pip install -r tools/codegen/python/client/requirements-dev.txt
    - .venv/bin/python -m pip install -r tools/codegen/python/server/requirements.txt
    - .venv/bin/python -m pip install -r tools/validate/requirements.txt
    - .venv/bin/python - <<'PY'
        import os
        import re
        import tomllib
        from pathlib import Path

        model_pyproject = Path("models/python/pyproject.toml")
        model_init = Path("models/python/src/arp_standard_model/__init__.py")
        client_pyproject = Path("clients/python/pyproject.toml")
        client_init = Path("clients/python/src/arp_standard_client/__init__.py")
        server_pyproject = Path("kits/python/pyproject.toml")
        server_init = Path("kits/python/src/arp_standard_server/__init__.py")
        conformance_pyproject = Path("conformance/python/pyproject.toml")
        conformance_init = Path("conformance/python/src/arp_conformance/__init__.py")

        def _read_pyproject(path: Path) -> str:
            pyproject = tomllib.loads(path.read_text(encoding="utf-8"))
            return pyproject["project"]["version"]

        def _read_init(path: Path) -> str:
            text = path.read_text(encoding="utf-8")
            match = re.search(r'__version__\s*=\s*["\']([^"\']+)["\']', text)
            if not match:
                raise SystemExit(f"Unable to find __version__ in {path}")
            return match.group(1)

        model_version = _read_pyproject(model_pyproject)
        client_version = _read_pyproject(client_pyproject)
        server_version = _read_pyproject(server_pyproject)
        conformance_version = _read_pyproject(conformance_pyproject)
        model_init_version = _read_init(model_init)
        client_init_version = _read_init(client_init)
        server_init_version = _read_init(server_init)
        conformance_init_version = _read_init(conformance_init)

        if model_version != client_version or model_version != server_version or model_version != conformance_version:
            raise SystemExit(
                "Version mismatch: "
                f"model={model_version} client={client_version} server={server_version} conformance={conformance_version}"
            )
        if model_init_version != model_version:
            raise SystemExit(
                f"Version mismatch: {model_pyproject}={model_version} vs {model_init}={model_init_version}"
            )
        if client_init_version != client_version:
            raise SystemExit(
                f"Version mismatch: {client_pyproject}={client_version} vs {client_init}={client_init_version}"
            )
        if server_init_version != server_version:
            raise SystemExit(
                f"Version mismatch: {server_pyproject}={server_version} vs {server_init}={server_init_version}"
            )
        if conformance_init_version != conformance_version:
            raise SystemExit(
                f"Version mismatch: {conformance_pyproject}={conformance_version} vs {conformance_init}={conformance_init_version}"
            )

        tag = os.environ.get("CI_COMMIT_TAG", "")
        if tag.startswith("v"):
            tag_version = tag.removeprefix("v")
            if tag_version != client_version:
                raise SystemExit(f"Tag/version mismatch: tag={tag_version} vs version={client_version}")
        PY
    - .venv/bin/python tools/lint/lint_json.py
    - .venv/bin/python tools/validate/validate_json_vectors.py --version v1 --include-examples
    - .venv/bin/python tools/validate/validate_openapi.py --version v1
    - .venv/bin/python tools/validate/validate_generated_artifacts.py
    - .venv/bin/python tools/codegen/python/model/generate.py --version v1
    - .venv/bin/python tools/codegen/python/client/generate.py --version v1
    - .venv/bin/python tools/codegen/python/server/generate.py --version v1
    - .venv/bin/python tools/conformance/sync_spec.py --version v1
    - .venv/bin/python -m pip install -e "models/python"
    - .venv/bin/python -m pip install -e "clients/python[dev]"
    - .venv/bin/python -m pip install -e "kits/python"
    - .venv/bin/python -m pip install -e "conformance/python"
    - .venv/bin/pyright -p clients/python/pyrightconfig.json
    - .venv/bin/pyright -p kits/python/pyrightconfig.json
    - .venv/bin/python -m unittest discover -s tests
    - .venv/bin/python -m build models/python --sdist --wheel --outdir models/python/dist
    - .venv/bin/python -m build clients/python --sdist --wheel --outdir clients/python/dist
    - .venv/bin/python -m build kits/python --sdist --wheel --outdir kits/python/dist
    - .venv/bin/python -m build conformance/python --sdist --wheel --outdir conformance/python/dist
    - .venv/bin/python -m twine check models/python/dist/*
    - .venv/bin/python -m twine check clients/python/dist/*
    - .venv/bin/python -m twine check kits/python/dist/*
    - .venv/bin/python -m twine check conformance/python/dist/*
    - .venv/bin/python tools/codegen/python/verify_dist_dependencies.py
  artifacts:
    paths:
      - models/python/dist/*
      - clients/python/dist/*
      - kits/python/dist/*
      - conformance/python/dist/*
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v/

publish_testpypi:
  stage: publish
  image: python:3.11
  dependencies:
    - release_build
  script:
    - python -m pip install --upgrade pip twine
    - export TWINE_USERNAME="__token__"
    - export TWINE_PASSWORD="${TESTPYPI_API_TOKEN}"
    - export TWINE_REPOSITORY_URL="https://test.pypi.org/legacy/"
    - twine upload models/python/dist/* clients/python/dist/* kits/python/dist/* conformance/python/dist/*
  rules:
    - if: $CI_COMMIT_TAG =~ /^v/
      when: manual

publish_pypi:
  stage: publish
  image: python:3.11
  dependencies:
    - release_build
  script:
    - python -m pip install --upgrade pip twine
    - export TWINE_USERNAME="__token__"
    - export TWINE_PASSWORD="${PYPI_API_TOKEN}"
    - twine upload models/python/dist/* clients/python/dist/* kits/python/dist/* conformance/python/dist/*
  rules:
    - if: $CI_COMMIT_TAG =~ /^v/
