name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      publish_to:
        description: "Publish destination"
        type: choice
        options:
          - testpypi
          - pypi
        default: testpypi

jobs:
  build-python-packages:
    name: Build Python model/client/server/conformance packages
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.versions.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce origin/main
        run: |
          git fetch origin main
          COMMIT="$(git rev-parse "${GITHUB_SHA}^{commit}")"
          if ! git merge-base --is-ancestor "$COMMIT" "origin/main"; then
            echo "Ref ${GITHUB_REF_NAME} ($COMMIT) is not contained in origin/main"
            exit 1
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Create venv
        run: python -m venv .venv

      - name: Verify version and tag
        id: versions
        run: |
          python - <<'PY'
          import os
          import re
          import tomllib
          from pathlib import Path

          model_pyproject = Path("models/python/pyproject.toml")
          model_init = Path("models/python/src/arp_standard_model/__init__.py")
          client_pyproject = Path("clients/python/pyproject.toml")
          client_init = Path("clients/python/src/arp_standard_client/__init__.py")
          server_pyproject = Path("kits/python/pyproject.toml")
          server_init = Path("kits/python/src/arp_standard_server/__init__.py")
          conformance_pyproject = Path("conformance/python/pyproject.toml")
          conformance_init = Path("conformance/python/src/arp_conformance/__init__.py")

          def _read_pyproject(path: Path) -> str:
              pyproject = tomllib.loads(path.read_text(encoding="utf-8"))
              return pyproject["project"]["version"]

          def _read_init(path: Path) -> str:
              text = path.read_text(encoding="utf-8")
              match = re.search(r'__version__\s*=\s*["\']([^"\']+)["\']', text)
              if not match:
                  raise SystemExit(f"Unable to find __version__ in {path}")
              return match.group(1)

          model_version = _read_pyproject(model_pyproject)
          client_version = _read_pyproject(client_pyproject)
          server_version = _read_pyproject(server_pyproject)
          conformance_version = _read_pyproject(conformance_pyproject)
          model_init_version = _read_init(model_init)
          client_init_version = _read_init(client_init)
          server_init_version = _read_init(server_init)
          conformance_init_version = _read_init(conformance_init)

          if model_version != client_version or model_version != server_version or model_version != conformance_version:
              raise SystemExit(
                  "Version mismatch: "
                  f"model={model_version} client={client_version} server={server_version} conformance={conformance_version}"
              )
          if model_init_version != model_version:
              raise SystemExit(
                  f"Version mismatch: {model_pyproject}={model_version} vs {model_init}={model_init_version}"
              )
          if client_init_version != client_version:
              raise SystemExit(
                  f"Version mismatch: {client_pyproject}={client_version} vs {client_init}={client_init_version}"
              )
          if server_init_version != server_version:
              raise SystemExit(
                  f"Version mismatch: {server_pyproject}={server_version} vs {server_init}={server_init_version}"
              )
          if conformance_init_version != conformance_version:
              raise SystemExit(
                  f"Version mismatch: {conformance_pyproject}={conformance_version} vs {conformance_init}={conformance_init_version}"
              )

          ref = os.environ.get("GITHUB_REF", "")
          if ref.startswith("refs/tags/"):
              tag = os.environ.get("GITHUB_REF_NAME", "")
              prefix = "v"
              if not tag.startswith(prefix):
                  raise SystemExit(f"Expected tag to start with '{prefix}': {tag}")
              tag_version = tag.removeprefix(prefix)
              if tag_version != client_version:
                  raise SystemExit(
                      f"Tag/version mismatch: tag={tag_version} vs version={client_version}"
                  )

          output_path = os.environ.get("GITHUB_OUTPUT")
          if output_path:
              with open(output_path, "a", encoding="utf-8") as f:
                  f.write(f"version={client_version}\n")
          print(f"Python package version: {client_version}")
          PY

      - name: Install build tooling
        run: .venv/bin/python -m pip install --upgrade pip && .venv/bin/python -m pip install build twine

      - name: Install codegen tooling
        run: |
          .venv/bin/python -m pip install -r tools/codegen/python/model/requirements.txt
          .venv/bin/python -m pip install -r tools/codegen/python/client/requirements.txt
          .venv/bin/python -m pip install -r tools/codegen/python/server/requirements.txt
          .venv/bin/python -m pip install -r tools/validate/requirements.txt

      - name: Validate OpenAPI specs
        run: .venv/bin/python tools/validate/validate_openapi.py --version v1

      - name: Validate generated artifacts are not checked in
        run: .venv/bin/python tools/validate/validate_generated_artifacts.py

      - name: Generate Python models
        run: .venv/bin/python tools/codegen/python/model/generate.py --version v1

      - name: Generate Python client
        run: .venv/bin/python tools/codegen/python/client/generate.py --version v1

      - name: Generate Python server
        run: .venv/bin/python tools/codegen/python/server/generate.py --version v1

      - name: Sync embedded conformance spec snapshot
        run: .venv/bin/python tools/conformance/sync_spec.py --version v1

      - name: Create codegen source artifact
        run: |
          mkdir -p artifacts
          tar -czf artifacts/python-codegen-src.tgz \
            clients/python/src/arp_standard_client \
            models/python/src/arp_standard_model/_generated.py \
            models/python/src/arp_standard_model/_requests.py \
            kits/python/src/arp_standard_server

      - uses: actions/upload-artifact@v4
        with:
          name: python-codegen-src
          path: artifacts/python-codegen-src.tgz

      - name: Install Python models (dev)
        run: .venv/bin/python -m pip install -e "models/python"

      - name: Install Python client (dev)
        run: .venv/bin/python -m pip install -e "clients/python[dev]"

      - name: Install Python server (dev)
        run: .venv/bin/python -m pip install -e "kits/python"

      - name: Install Python conformance (dev)
        run: .venv/bin/python -m pip install -e "conformance/python"

      - name: Pyright
        run: .venv/bin/pyright -p clients/python/pyrightconfig.json

      - name: Pyright (server)
        run: .venv/bin/pyright -p kits/python/pyrightconfig.json

      - name: Pyright (models)
        run: .venv/bin/pyright --pythonpath .venv/bin/python models/python/src/arp_standard_model

      - name: Pyright (conformance)
        run: .venv/bin/pyright --pythonpath .venv/bin/python conformance/python/src/arp_conformance

      - name: Unit tests
        run: .venv/bin/python -m unittest discover -s tests

      - name: Build model sdist + wheel
        run: .venv/bin/python -m build models/python --sdist --wheel --outdir models/python/dist

      - name: Build client sdist + wheel
        run: .venv/bin/python -m build clients/python --sdist --wheel --outdir clients/python/dist

      - name: Build server sdist + wheel
        run: .venv/bin/python -m build kits/python --sdist --wheel --outdir kits/python/dist

      - name: Build conformance sdist + wheel
        run: .venv/bin/python -m build conformance/python --sdist --wheel --outdir conformance/python/dist

      - name: Check model dist metadata
        run: .venv/bin/python -m twine check models/python/dist/*

      - name: Check client dist metadata
        run: .venv/bin/python -m twine check clients/python/dist/*

      - name: Check server dist metadata
        run: .venv/bin/python -m twine check kits/python/dist/*

      - name: Check conformance dist metadata
        run: .venv/bin/python -m twine check conformance/python/dist/*

      - name: Verify dist dependencies
        run: .venv/bin/python tools/codegen/python/verify_dist_dependencies.py

      - uses: actions/upload-artifact@v4
        with:
          name: python-model-dist
          path: models/python/dist/*

      - uses: actions/upload-artifact@v4
        with:
          name: python-client-dist
          path: clients/python/dist/*

      - uses: actions/upload-artifact@v4
        with:
          name: python-server-dist
          path: kits/python/dist/*

      - uses: actions/upload-artifact@v4
        with:
          name: python-conformance-dist
          path: conformance/python/dist/*

  publish-python-packages:
    name: Publish Python model/client/server/conformance packages
    needs: build-python-packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: python-model-dist
          path: dist/model

      - uses: actions/download-artifact@v4
        with:
          name: python-client-dist
          path: dist/client

      - uses: actions/download-artifact@v4
        with:
          name: python-server-dist
          path: dist/server

      - uses: actions/download-artifact@v4
        with:
          name: python-conformance-dist
          path: dist/conformance

      - name: Publish model to TestPyPI (trusted publishing)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to == 'testpypi'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/model
          repository-url: https://test.pypi.org/legacy/

      - name: Publish client to TestPyPI (trusted publishing)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to == 'testpypi'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/client
          repository-url: https://test.pypi.org/legacy/

      - name: Publish server to TestPyPI (trusted publishing)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to == 'testpypi'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/server
          repository-url: https://test.pypi.org/legacy/

      - name: Publish conformance to TestPyPI (trusted publishing)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to == 'testpypi'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/conformance
          repository-url: https://test.pypi.org/legacy/

      - name: Publish model to PyPI (trusted publishing)
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to == 'pypi')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/model

      - name: Publish client to PyPI (trusted publishing)
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to == 'pypi')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/client

      - name: Publish server to PyPI (trusted publishing)
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to == 'pypi')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/server

      - name: Publish conformance to PyPI (trusted publishing)
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to == 'pypi')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/conformance

  github-release:
    name: GitHub Release (Python packages)
    needs: [build-python-packages, publish-python-packages]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: python-model-dist
          path: dist/model

      - uses: actions/download-artifact@v4
        with:
          name: python-client-dist
          path: dist/client

      - uses: actions/download-artifact@v4
        with:
          name: python-server-dist
          path: dist/server

      - uses: actions/download-artifact@v4
        with:
          name: python-conformance-dist
          path: dist/conformance

      - name: Create GitHub Release (with artifacts)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          prerelease: ${{ contains(needs.build-python-packages.outputs.version, 'a') || contains(needs.build-python-packages.outputs.version, 'b') || contains(needs.build-python-packages.outputs.version, 'rc') }}
          files: |
            dist/model/*
            dist/client/*
            dist/server/*
            dist/conformance/*
          fail_on_unmatched_files: true
